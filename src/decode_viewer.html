<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decode Viewer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /*
            General styles for the body and the main container.
            Sets up the light gray theme and the basic flexbox layout.
        */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f7; /* Light gray background, similar to Apple's design */
            color: #1d1d1f; /* Dark text color for readability */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 420px; /* A typical mobile phone width */
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #ffffff; /* White panel background */
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /*
            Styles for the top control buttons panel.
            Uses flexbox to space the buttons evenly.
        */
        .controls-panel {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0; /* Subtle separator line */
        }

        .control-button {
            flex-grow: 1; /* Makes buttons fill the space */
            margin: 0 5px;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            background-color: #f0f0f0; /* Light button background */
            color: #1d1d1f;
            transition: background-color 0.2s, transform 0.1s;
        }

        .control-button:active {
            background-color: #dcdcdc;
            transform: scale(0.98);
        }
        
        /*
            Styles for the scrollable list of tracks.
            Allows the list to take up available space and scroll.
        */
        .track-list-panel {
            flex-grow: 1; /* Makes this panel take up the remaining vertical space */
            overflow-y: auto; /* Enables vertical scrolling */
            -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
            padding: 10px 0;
        }

        .track-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .track-item:last-child {
            border-bottom: none; /* No border for the last item */
        }

        .track-item:hover {
            background-color: #f5f5f7;
        }

        .track-item.playing {
            background-color: #e0e0e0; /* Highlight for the currently playing track */
        }

        .track-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            margin-left: 15px;
        }

        .track-title {
            font-weight: 500;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Adds "..." for long titles */
        }

        .track-type {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-icon-list {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            background-color: #dcdcdc; /* Placeholder background */
        }

        /*
            Styles for the currently playing track panel at the bottom.
            Uses flexbox to align the image and text.
        */
        .playing-info-panel {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: #e0e0e0; /* A darker gray for contrast */
            border-top: 1px solid #dcdcdc;
        }

        .playing-icon {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background-color: #dcdcdc; /* Placeholder background */
        }

        .playing-text {
            flex-grow: 1;
            margin-left: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .playing-title {
            font-weight: 700;
            font-size: 18px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playing-type {
            font-size: 15px;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls-panel">
            <button id="startButton" class="control-button">Start</button>
            <button id="stopButton" class="control-button">Stop</button>
            <button id="offsetButton" class="control-button">Offset++</button>
            <button id="resetButton" class="control-button">Reset</button>
        </div>

        <div id="trackListPanel" class="track-list-panel">
            </div>

        <div class="playing-info-panel">
            <img id="playingIcon" class="playing-icon" src="" alt="Album Art">
            <div class="playing-text">
                <span id="playingTitle" class="playing-title">Loading...</span>
                <span id="playingTime" class="playing-type"></span>
                <span id="tapeCounter" class="playing-type"></span>
                <span id="dataErrors" class="playing-type"></span>
                <span id="playingType" class="playing-type"></span>
            </div>
        </div>
    </div>

    <script>
        /*
            JavaScript for dynamic content and event handling.
        */
        // Dynamically set the backend URL based on the server's address
        const BACKEND_URL = `http://${window.location.hostname}:8192`;

        const trackListPanel = document.getElementById('trackListPanel');
        const playingIcon = document.getElementById('playingIcon');
        const playingTitle = document.getElementById('playingTitle');
        const playingType = document.getElementById('playingType');
        const playingTime = document.getElementById('playingTime');
        const tapeCounter = document.getElementById('tapeCounter');
        const dataErrors = document.getElementById('dataErrors');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const offsetButton = document.getElementById('offsetButton');
        const resetButton = document.getElementById('resetButton');
        
        let currentTrackIndex = -1;
        let isPlaying = false;
        let tracks = [];
        let newTrack = false;
        
        // ------------------- Backend Communication (Simulated) -------------------

        /**
         * Simulates a successful response from the backend with dummy data.
         * The data now includes a 'trackType' field instead of 'artist'.
         */
        function getDummyStateData() {
            return {
                tracks: [
                    { id: 1, title: "Morning Dew", trackType: "MP3", albumArt: "https://placehold.co/400x400/90EE90/000000?text=MD" },
                    { id: 2, title: "Urban Sunset", trackType: "Flac", albumArt: "https://placehold.co/400x400/FFA07A/000000?text=US" },
                    { id: 3, title: "Lost in the Stars", trackType: "YT", albumArt: "https://placehold.co/400x400/87CEFA/000000?text=LS" },
                    { id: 4, title: "Rainy Cafe", trackType: "SP", albumArt: "https://placehold.co/400x400/DDA0DD/000000?text=RC" },
                    { id: 5, title: "Driving at Night", trackType: "MP3", albumArt: "https://placehold.co/400x400/C0C0C0/000000?text=DN" },
                    { id: 6, title: "Ocean Breeze", trackType: "Flac", albumArt: "https://placehold.co/400x400/ADD8E6/000000?text=OB" },
                    { id: 7, title: "Digital Harmony", trackType: "YT", albumArt: "https://placehold.co/400x400/F0E68C/000000?text=DH" },
                    { id: 8, title: "Forest Walk", trackType: "SP", albumArt: "https://placehold.co/400x400/2E8B57/000000?text=FW" },
                    { id: 9, title: "Starlight", trackType: "MP3", albumArt: "https://placehold.co/400x400/F8F8FF/000000?text=SL" },
                    { id: 10, title: "Midnight Funk", trackType: "Flac", albumArt: "https://placehold.co/400x400/8A2BE2/000000?text=MF" }
                ],
                // Set the initial currently playing track and state
                currentlyPlaying: { id: 1, title: "Morning Dew", trackType: "MP3", albumArt: "https://placehold.co/400x400/90EE90/000000?text=MD" },
                isPlaying: true
            };
        }

        /**
         * Sends a GET request to the backend server with a specific command.
         * The UI does not change immediately; it relies on the periodic fetch
         * to update its state.
         * @param {string} command - The command to send (e.g., 'start', 'stop').
         */
        async function sendControlCommand(command) {
            try {
                // In a real application, you would uncomment this line:
                const response = await fetch(`${BACKEND_URL}/dcc/?c=${command}`);
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                // For this example with dummy data, we just log the action
                console.log(`Command '${command}' sent to backend.`);
            } catch (error) {
                console.error(`Failed to send command '${command}':`, error);
            }
        }

        /**
         * Fetches all current state data from the backend.
         * This function is responsible for all UI updates.
         */
        async function fetchStateData() {
            try {
                // In a real application, you would uncomment this:
                const response = await fetch(`${BACKEND_URL}/dcs`);
                if (!response.ok) {
                    throw new Error(`Server state fetch failed with status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // For this example, we use the dummy data
                //const data = getDummyStateData();
                
                tracks = data.tracks || [];
                const currentlyPlaying = data.currentlyPlaying || null;
                isPlaying = data.isPlaying || false;
                newTracks = data.newTrack || false;

                // Update the current track index to match the backend's state
                if (isPlaying) {
                    currentTrackIndex = data.currentlyPlayingId;
                    let track = tracks[currentTrackIndex]
                    updatePlayingPanel(track, currentlyPlaying);
                } else {
                    currentTrackIndex = -1;
                    updatePlayingPanel(null, currentlyPlaying);
                }
                
                renderTrackList();
            } catch (error) {
                console.error("Error fetching state data:", error);
                playingTitle.textContent = "Error loading data.";
                playingType.textContent = "Check server connection.";
            }
        }

        // Periodically fetch data from the "server" to keep the UI in sync
        setInterval(fetchStateData, 1000); // Fetch every 1000ms (1 second)

        // ------------------- UI Rendering Functions -------------------

        /**
         * Renders the list of tracks in the scrollable panel.
         * The 'playing' class is added based on the currentTrackIndex.
         */
        function renderTrackList() {
            trackListPanel.innerHTML = '';
            if (tracks.length === 0) {
                trackListPanel.innerHTML = '<p style="text-align: center; padding: 20px; color: #888;">No tracks found.</p>';
                return;
            }

            tracks.forEach((track, index) => {
                const trackItem = document.createElement('div');
                trackItem.classList.add('track-item');
                if (isPlaying && index === currentTrackIndex) {
                    trackItem.classList.add('playing');
                }
                trackItem.dataset.id = track.id; // Use ID for a more robust lookup

                trackItem.innerHTML = `
                    <img src="${track.albumArt || 'https://placehold.co/400x400/C0C0C0/000000?text=NA'}" alt="Album Art" class="track-icon-list">
                    <div class="track-info">
                        <span class="track-title">${track.title || 'Unknown Title'}</span>
                        <span class="track-type">${track.trackType || 'Unknown Type'}</span>
                    </div>
                `;
                
                trackListPanel.appendChild(trackItem);
            });
        }

        /**
         * Updates the "currently playing" panel.
         * @param {object} track - The currently playing track object.
         * @param {string} currentlyPlaying - information about currently playing
         */
        function updatePlayingPanel(track, currentlyPlaying) {
            if (currentlyPlaying && isPlaying) {
                // split the currently playing string into an array
                let sa = currentlyPlaying.split(/\r?\n/);
                //console.log(track);
                //console.log(sa);
                if(sa.length === 0) return;
                
                let trackTitle = sa[0];
                let trackPlayTime = sa[1];
                let trackTapeCount = "";
                let trackDataErrors = "";
                
                if(sa.length === 5) { // we playing mp3 or flac        
                    trackTapeCount = sa[3];
                    trackDataErrors = sa[4];
                } else {
                    trackTapeCount = sa[2];
                    trackDataErrors = sa[3];
                }
                
                
                let trackString = zeroPadToThreeDigits(track.id);
                playingIcon.src = `https://placehold.co/400x400/90EE90/000000?text=${trackString}`;
                playingTitle.textContent = trackTitle  || 'Unknown Title';
                playingTime.textContent = trackPlayTime || 'No Playtime Value';
                tapeCounter.textContent = trackTapeCount || 'No Tape Counter Value';
                dataErrors.textContent = trackDataErrors || 'No Data Error Value';
                playingType.textContent = track.trackType || 'Unknown Type';
            } else {
                // see if we reach a padding section
                if(currentlyPlaying !== null && currentlyPlaying.includes('Padding')) {
                    currentlyPlaying = "Reset Media and Offset";
                }
                
                playingIcon.src = "https://placehold.co/400x400/C0C0C0/000000?text=CF";
                playingTitle.textContent = currentlyPlaying;
                playingTime.textContent = "";
                tapeCounter.textContent = "";
                dataErrors.textContent = "";
                playingType.textContent = "";
            }
            
        }
        
        // function to left zero pad an integer to 3 digits and return string
        function zeroPadToThreeDigits(number) {
            // Convert the number to a string
            const numString = String(number);

            // Use padStart to add leading zeros until the length is 3
            return numString.padStart(3, '0');
        }
        
        // ------------------- Event Listeners for Buttons -------------------

        startButton.addEventListener('click', () => {
            sendControlCommand('start');
        });

        stopButton.addEventListener('click', () => {
            sendControlCommand('stop');
        });

        offsetButton.addEventListener('click', () => {
            sendControlCommand('offset');
        });

        resetButton.addEventListener('click', () => {
            sendControlCommand('reset');
        });

        // Initial fetch to populate the list on page load
        fetchStateData();
    </script>
</body>
</html>